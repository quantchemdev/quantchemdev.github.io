name: Gallery Bot - Slack to GitHub

on:
  schedule:
    # Run every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-slack-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install slack-sdk pyyaml requests
    
    - name: Process Slack messages (add and delete)
      env:
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
      run: |
        python << 'EOF'
        import os
        import yaml
        import requests
        from slack_sdk import WebClient
        from slack_sdk.errors import SlackApiError
        from datetime import datetime, timedelta
        import re
        
        print("=" * 60)
        print("üîç DEBUGGING MODE - Detailed Slack API Calls")
        print("=" * 60)
        
        # Initialize Slack client
        print("\n1Ô∏è‚É£ Initializing Slack client...")
        client = WebClient(token=os.environ["SLACK_BOT_TOKEN"])
        channel_id = os.environ["SLACK_CHANNEL_ID"]
        print(f"   ‚úì Channel ID: {channel_id}")
        
        # Test auth first
        print("\n2Ô∏è‚É£ Testing authentication...")
        try:
            auth_test = client.auth_test()
            print(f"   ‚úì Auth successful!")
            print(f"   - User: {auth_test['user']}")
            print(f"   - Team: {auth_test['team']}")
            print(f"   - Bot ID: {auth_test.get('bot_id', 'N/A')}")
        except SlackApiError as e:
            print(f"   ‚ùå Auth failed: {e.response['error']}")
            print(f"   Full error: {e.response}")
            exit(1)
        
        # Get channel info to verify type
        print(f"\n3Ô∏è‚É£ Getting channel info for {channel_id}...")
        try:
            channel_info = client.conversations_info(channel=channel_id)
            print(f"   ‚úì Channel info retrieved:")
            print(f"   - Name: {channel_info['channel']['name']}")
            print(f"   - Is Private: {channel_info['channel']['is_private']}")
            print(f"   - Is Member: {channel_info['channel']['is_member']}")
            
            if not channel_info['channel']['is_member']:
                print(f"\n   ‚ö†Ô∏è WARNING: Bot is not a member of this channel!")
                print(f"   Please invite the bot to #{channel_info['channel']['name']}")
                exit(1)
                
        except SlackApiError as e:
            print(f"   ‚ùå Failed to get channel info: {e.response['error']}")
            print(f"   Full error: {e.response}")
            
            if e.response['error'] == 'missing_scope':
                print(f"\n   üí° Required scope: conversations.info")
                if 'needed' in e.response:
                    print(f"   Needed scope: {e.response['needed']}")
            elif e.response['error'] == 'channel_not_found':
                print(f"\n   üí° Channel ID might be incorrect")
                print(f"   Current ID: {channel_id}")
            
            exit(1)
        
        # Get messages from last 2 hours
        two_hours_ago = (datetime.now() - timedelta(hours=2)).timestamp()
        
        changes_made = False
        
        print(f"\n4Ô∏è‚É£ Fetching messages from channel (last 2 hours)...")
        try:
            result = client.conversations_history(
                channel=channel_id,
                oldest=str(two_hours_ago),
                limit=50
            )
            print(f"   ‚úì Retrieved {len(result['messages'])} messages")
            
            messages = result["messages"]
            new_entries = []
            entries_to_delete = []
            
            # Load existing YAML
            yaml_path = "_data/gallery/items.yml"
            with open(yaml_path, "r") as f:
                existing_entries = yaml.safe_load(f) or []
            
            print(f"\n5Ô∏è‚É£ Processing messages...")
            
            # STEP 1: Check for deletions (messages with ‚ùå reaction)
            deletion_count = 0
            for message in messages:
                if "reactions" in message:
                    for reaction in message["reactions"]:
                        if reaction["name"] == "x":  # ‚ùå emoji is "x" in Slack
                            deletion_count += 1
                            if "files" in message:
                                for file in message["files"]:
                                    if file["mimetype"].startswith("image/"):
                                        text = message.get("text", "").strip()
                                        parts = [p.strip() for p in text.split("|")]
                                        description = parts[0] if len(parts) > 0 else "Untitled"
                                        
                                        for entry in existing_entries:
                                            if entry["description"] == description:
                                                entries_to_delete.append(entry)
                                                print(f"   üóëÔ∏è Marked for deletion: {entry['description']}")
            
            if deletion_count > 0:
                print(f"   Found {deletion_count} messages with ‚ùå reaction")
            
            # STEP 2: Check for new additions
            addition_count = 0
            for message in messages:
                has_x_reaction = False
                if "reactions" in message:
                    for reaction in message["reactions"]:
                        if reaction["name"] == "x":
                            has_x_reaction = True
                            break
                
                if has_x_reaction:
                    continue
                
                if "files" in message:
                    for file in message["files"]:
                        if file["mimetype"].startswith("image/"):
                            text = message.get("text", "").strip()
                            
                            if not text or message.get("bot_id"):
                                continue
                            
                            parts = [p.strip() for p in text.split("|")]
                            description = parts[0] if len(parts) > 0 else "Untitled"
                            
                            already_exists = any(e["description"] == description for e in existing_entries)
                            if already_exists:
                                print(f"   ‚è≠Ô∏è Skipping duplicate: {description}")
                                continue
                            
                            addition_count += 1
                            
                            year = None
                            month = None
                            place = None
                            
                            if len(parts) >= 2:
                                time_part = parts[1].strip()
                                if re.match(r'^\d{4}$', time_part):
                                    year = time_part
                                else:
                                    year_match = re.search(r'\b(19|20)\d{2}\b', time_part)
                                    if year_match:
                                        year = year_match.group()
                                        month_part = time_part.replace(year, '').strip()
                                        if month_part:
                                            month = month_part
                            
                            if len(parts) >= 3:
                                place = parts[2].strip()
                            
                            timestamp = datetime.now().strftime("%Y%m%d-%H%M%S")
                            clean_desc = re.sub(r'[^a-zA-Z0-9\s-]', '', description.lower())
                            clean_desc = re.sub(r'\s+', '-', clean_desc)[:50]
                            file_ext = file["name"].split(".")[-1]
                            filename = f"{timestamp}-{clean_desc}.{file_ext}"
                            
                            print(f"   ‚¨áÔ∏è Downloading: {filename}")
                            headers = {"Authorization": f"Bearer {os.environ['SLACK_BOT_TOKEN']}"}
                            
                            download_url = file.get("url_private_download", file.get("url_private"))
                            img_response = requests.get(download_url, headers=headers)
                            
                            if img_response.status_code == 200:
                                filepath = f"assets/gallery/{filename}"
                                with open(filepath, "wb") as f:
                                    f.write(img_response.content)
                                print(f"   ‚úÖ Saved: {filepath}")
                                
                                entry = {"filename": filename, "description": description}
                                if year:
                                    entry["year"] = int(year)
                                if month:
                                    entry["month"] = month
                                if place:
                                    entry["place"] = place
                                
                                new_entries.append(entry)
                                changes_made = True
                            else:
                                print(f"   ‚ùå Failed to download: {img_response.status_code}")
            
            if addition_count > 0:
                print(f"   Found {addition_count} new images to add")
            
            # STEP 3: Apply deletions
            if entries_to_delete:
                print(f"\n6Ô∏è‚É£ Applying deletions...")
                for entry in entries_to_delete:
                    filepath = f"assets/gallery/{entry['filename']}"
                    if os.path.exists(filepath):
                        os.remove(filepath)
                        print(f"   üóëÔ∏è Deleted file: {filepath}")
                    
                    existing_entries = [e for e in existing_entries if e["description"] != entry["description"]]
                
                changes_made = True
            
            # STEP 4: Add new entries
            if new_entries:
                existing_entries.extend(new_entries)
                print(f"\n7Ô∏è‚É£ Added {len(new_entries)} new entries")
                changes_made = True
            
            # STEP 5: Save YAML if changes made
            if changes_made:
                with open(yaml_path, "w") as f:
                    yaml.dump(existing_entries, f, default_flow_style=False, allow_unicode=True, sort_keys=False)
                
                with open("/tmp/changes_made", "w") as f:
                    f.write("yes")
                
                print("\n‚úÖ Changes saved to YAML")
            else:
                print("\n‚ÑπÔ∏è No changes detected")
            
            print("\n" + "=" * 60)
            print("üéâ Script completed successfully!")
            print("=" * 60)
                
        except SlackApiError as e:
            print(f"\n‚ùå Slack API Error at conversations_history")
            print(f"   Error type: {e.response['error']}")
            print(f"   Full response: {e.response}")
            
            # Helpful hints based on error
            if e.response['error'] == 'missing_scope':
                print("\nüí° MISSING SCOPE for conversations_history!")
                
                # Check if needed scope is in response
                if 'needed' in e.response:
                    print(f"   Needed scope: {e.response['needed']}")
                
                print("\n   For PRIVATE channels, add this scope:")
                print("   - groups:history")
                print("\n   For PUBLIC channels, add this scope:")
                print("   - channels:history")
                
            elif e.response['error'] == 'not_in_channel':
                print("\nüí° Bot is not in the channel!")
                print("   1. Go to your Slack channel")
                print("   2. Type: @Gallery Bot")
                print("   3. Click 'Invite to Channel'")
            
            exit(1)
        except Exception as e:
            print(f"\n‚ùå Unexpected Error: {str(e)}")
            import traceback
            traceback.print_exc()
            exit(1)
        
        EOF
    
    - name: Commit and push if changes
      run: |
        if [ -f /tmp/changes_made ]; then
          git config user.name "Gallery Bot"
          git config user.email "bot@quantchemdev.github.io"
          git add assets/gallery/ _data/gallery/items.yml
          
          if git diff --cached --name-only | grep -q "^assets/gallery/"; then
            git commit -m "üñºÔ∏è Update gallery (added/removed images from Slack)"
          else
            git commit -m "üñºÔ∏è Add new gallery images from Slack"
          fi
          
          git push
          echo "‚úÖ Changes committed and pushed"
        else
          echo "‚ÑπÔ∏è No changes to commit"
        fi
